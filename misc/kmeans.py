data = [{"ID": "J0847+0112", "Mg_Fe": 0.3, "t_bur": 12.0, "t_max": 11.6, "delta_t": 0.2, "MH_bur": 0.30, "MH_max": 0.35, "delta_MH": 0.02, "f_M_sfm": 0.9988, "f_M_sfm_err": 0.0002, "t75": 0.9, "t75_err": 0.3, "t_fin": 2.0, "t_fin_err": 0.7, "t_Univ_z": 11.52, "DoR": 0.83},
   {"ID": "J2305-3436", "Mg_Fe": 0.3, "t_bur": 10.5, "t_max": 10.1, "delta_t": 0.2, "MH_bur": 0.32, "MH_max": 0.34, "delta_MH": 0.02, "f_M_sfm": 0.9980, "f_M_sfm_err": 0.0007, "t75": 1.0, "t75_err": 0.3, "t_fin": 2.0, "t_fin_err": 0.7, "t_Univ_z": 10.29, "DoR": 0.80},
   {"ID": "J0920+0147", "Mg_Fe": 0.4, "t_bur": 11.4, "t_max": 11.1, "delta_t": 0.2, "MH_bur": 0.27, "MH_max": 0.31, "delta_MH": 0.02, "f_M_sfm": 0.9950, "f_M_sfm_err": 0.0013, "t75": 0.9, "t75_err": 0.2, "t_fin": 3.0, "t_fin_err": 4.0, "t_Univ_z": 11.11, "DoR": 0.79},
   {"ID": "J2204-3112", "Mg_Fe": 0.3, "t_bur": 11.0, "t_max": 10.6, "delta_t": 0.3, "MH_bur": 0.27, "MH_max": 0.30, "delta_MH": 0.02, "f_M_sfm": 0.9992, "f_M_sfm_err": 0.0003, "t75": 1.0, "t75_err": 0.4, "t_fin": 2.5, "t_fin_err": 0.9, "t_Univ_z": 10.67, "DoR": 0.78},
   {"ID": "J1438-0127", "Mg_Fe": 0.4, "t_bur": 10.5, "t_max": 9.9, "delta_t": 0.4, "MH_bur": 0.05, "MH_max": 0.11, "delta_MH": 0.05, "f_M_sfm": 0.9971, "f_M_sfm_err": 0.0003, "t75": 0.9, "t75_err": 0.3, "t_fin": 3.0, "t_fin_err": 1.1, "t_Univ_z": 10.40, "DoR": 0.78},
   {"ID": "J1040+0056", "Mg_Fe": 0.4, "t_bur": 10.9, "t_max": 10.6, "delta_t": 0.2, "MH_bur": 0.27, "MH_max": 0.28, "delta_MH": 0.02, "f_M_sfm": 0.991, "f_M_sfm_err": 0.003, "t75": 1.0, "t75_err": 0.3, "t_fin": 3.0, "t_fin_err": 3.9, "t_Univ_z": 10.54, "DoR": 0.77},
   {"ID": "J0842+0059", "Mg_Fe": 0.4, "t_bur": 10.5, "t_max": 10.0, "delta_t": 0.2, "MH_bur": 0.22, "MH_max": 0.26, "delta_MH": 0.02, "f_M_sfm": 0.983, "f_M_sfm_err": 0.007, "t75": 1.1, "t75_err": 0.3, "t_fin": 3.5, "t_fin_err": 1.8, "t_Univ_z": 10.31, "DoR": 0.73},
   {"ID": "J0211-3155", "Mg_Fe": 0.3, "t_bur": 10.4, "t_max": 9.9, "delta_t": 0.2, "MH_bur": 0.26, "MH_max": 0.28, "delta_MH": 0.03, "f_M_sfm": 0.989, "f_M_sfm_err": 0.003, "t75": 1.1, "t75_err": 0.3, "t_fin": 3.5, "t_fin_err": 4.0, "t_Univ_z": 10.26, "DoR": 0.72},
   {"ID": "J2359-3320", "Mg_Fe": 0.2, "t_bur": 10.4, "t_max": 9.7, "delta_t": 0.2, "MH_bur": 0.34, "MH_max": 0.33, "delta_MH": 0.03, "f_M_sfm": 0.993, "f_M_sfm_err": 0.002, "t75": 1.4, "t75_err": 0.4, "t_fin": 3.0, "t_fin_err": 3.9, "t_Univ_z": 10.38, "DoR": 0.71},
   {"ID": "J0920+0212", "Mg_Fe": 0.3, "t_bur": 10.4, "t_max": 9.9, "delta_t": 0.3, "MH_bur": 0.23, "MH_max": 0.26, "delta_MH": 0.03, "f_M_sfm": 0.968, "f_M_sfm_err": 0.012, "t75": 0.9, "t75_err": 0.2, "t_fin": 7.0, "t_fin_err": 3.8, "t_Univ_z": 10.46, "DoR": 0.64},
   {"ID": "J1412-0020", "Mg_Fe": 0.0, "t_bur": 10.3, "t_max": 9.3, "delta_t": 0.3, "MH_bur": 0.40, "MH_max": 0.32, "delta_MH": 0.03, "f_M_sfm": 0.93, "f_M_sfm_err": 0.03, "t75": 1.9, "t75_err": 0.6, "t_fin": 4.5, "t_fin_err": 4.1, "t_Univ_z": 10.48, "DoR": 0.61},
   {"ID": "J1449-0138", "Mg_Fe": 0.3, "t_bur": 10.9, "t_max": 10.2, "delta_t": 0.3, "MH_bur": 0.21, "MH_max": 0.25, "delta_MH": 0.03, "f_M_sfm": 0.961, "f_M_sfm_err": 0.019, "t75": 1.5, "t75_err": 0.3, "t_fin": 6.5, "t_fin_err": 3.8, "t_Univ_z": 10.60, "DoR": 0.60},
   {"ID": "J0224-3143", "Mg_Fe": 0.3, "t_bur": 9.8, "t_max": 9.4, "delta_t": 0.3, "MH_bur": 0.18, "MH_max": 0.21, "delta_MH": 0.03, "f_M_sfm": 0.976, "f_M_sfm_err": 0.004, "t75": 0.9, "t75_err": 0.2, "t_fin": 9.0, "t_fin_err": 3.7, "t_Univ_z": 9.53, "DoR": 0.56},
   {"ID": "J0838+0052", "Mg_Fe": 0.3, "t_bur": 10.5, "t_max": 9.8, "delta_t": 0.5, "MH_bur": 0.11, "MH_max": 0.13, "delta_MH": 0.04, "f_M_sfm": 0.85, "f_M_sfm_err": 0.05, "t75": 1.9, "t75_err": 0.6, "t_fin": 6.0, "t_fin_err": 3.3, "t_Univ_z": 10.56, "DoR": 0.54},
   {"ID": "J0217-2957", "Mg_Fe": 0.4, "t_bur": 10.6, "t_max": 10.3, "delta_t": 0.3, "MH_bur": 0.17, "MH_max": 0.19, "delta_MH": 0.04, "f_M_sfm": 0.949, "f_M_sfm_err": 0.013, "t75": 1.1, "t75_err": 0.3, "t_fin": 10.0, "t_fin_err": 4.0, "t_Univ_z": 10.64, "DoR": 0.51},
   {"ID": "J2202-3101", "Mg_Fe": 0.2, "t_bur": 10.4, "t_max": 9.5, "delta_t": 0.5, "MH_bur": 0.18, "MH_max": 0.22, "delta_MH": 0.03, "f_M_sfm": 0.82, "f_M_sfm_err": 0.07, "t75": 1.5, "t75_err": 0.4, "t_fin": 8.0, "t_fin_err": 2.9, "t_Univ_z": 10.10, "DoR": 0.48},
   {"ID": "J1457-0140", "Mg_Fe": 0.2, "t_bur": 9.2, "t_max": 8.5, "delta_t": 0.5, "MH_bur": 0.11, "MH_max": 0.12, "delta_MH": 0.05, "f_M_sfm": 0.81, "f_M_sfm_err": 0.07, "t75": 2.1, "t75_err": 0.7, "t_fin": 7.0, "t_fin_err": 2.7, "t_Univ_z": 9.93, "DoR": 0.47},
   {"ID": "J0844+0148", "Mg_Fe": 0.4, "t_bur": 9.8, "t_max": 9.1, "delta_t": 0.1, "MH_bur": 0.12, "MH_max": 0.17, "delta_MH": 0.05, "f_M_sfm": 0.91, "f_M_sfm_err": 0.02, "t75": 1.5, "t75_err": 0.4, "t_fin": 10.0, "t_fin_err": 4.0, "t_Univ_z": 10.43, "DoR": 0.45},
   {"ID": "J1218+0232", "Mg_Fe": 0.3, "t_bur": 10.2, "t_max": 9.3, "delta_t": 0.4, "MH_bur": 0.06, "MH_max": 0.14, "delta_MH": 0.05, "f_M_sfm": 0.89, "f_M_sfm_err": 0.04, "t75": 1.5, "t75_err": 0.5, "t_fin": 9.5, "t_fin_err": 3.3, "t_Univ_z": 10.20, "DoR": 0.45},
   {"ID": "J2356-3332", "Mg_Fe": 0.2, "t_bur": 8.9, "t_max": 7.9, "delta_t": 0.7, "MH_bur": 0.25, "MH_max": 0.29, "delta_MH": 0.05, "f_M_sfm": 0.90, "f_M_sfm_err": 0.02, "t75": 1.7, "t75_err": 0.6, "t_fin": 9.5, "t_fin_err": 3.9, "t_Univ_z": 9.92, "DoR": 0.44},
   {"ID": "J0917-0123", "Mg_Fe": 0.4, "t_bur": 9.6, "t_max": 8.4, "delta_t": 0.3, "MH_bur": 0.10, "MH_max": 0.18, "delta_MH": 0.04, "f_M_sfm": 0.89, "f_M_sfm_err": 0.03, "t75": 1.6, "t75_err": 0.5, "t_fin": 9.5, "t_fin_err": 3.9, "t_Univ_z": 9.73, "DoR": 0.44},
   {"ID": "J0918+0122", "Mg_Fe": 0.2, "t_bur": 9.3, "t_max": 8.6, "delta_t": 0.3, "MH_bur": 0.20, "MH_max": 0.23, "delta_MH": 0.05, "f_M_sfm": 0.90, "f_M_sfm_err": 0.03, "t75": 1.6, "t75_err": 0.5, "t_fin": 9.5, "t_fin_err": 4.0, "t_Univ_z": 9.62, "DoR": 0.43}
        ]

import pandas as pd
import numpy as np
from sklearn.preprocessing import StandardScaler
from sklearn.cluster import KMeans
import matplotlib.pyplot as plt
import seaborn as sns

df = pd.DataFrame(data=data) #the raw data in a pandas df
df = df.sample(frac=1, random_state=42).reset_index(drop=True)

# Prepare data and perform clustering
features_for_clustering = ['Mg_Fe', 't_bur', 't_max', 'delta_t',
                           'MH_bur', 'MH_max', 'delta_MH', 'f_M_sfm', 't75', 't_fin', 't_Univ_z']

# Scale features and perform clustering
X = df[features_for_clustering]
scaler = StandardScaler()
X_scaled = scaler.fit_transform(X)

k = 3
kmeans = KMeans(n_clusters=k, random_state=42)
clusters = kmeans.fit_predict(X_scaled)

# Add clusters to dataframe
df_clustered = df.copy()
df_clustered['Cluster'] = clusters

# Create DoR groups (can adjust these thresholds)
df_clustered['DoR_group'] = pd.qcut(df_clustered['DoR'], q=3, labels=['Low', 'Medium', 'High'])

# Set up the plotting grid
n_features = len(features_for_clustering)
n_cols = 3
n_rows = (n_features + n_cols - 1) // n_cols
plt.figure(figsize=(20, 5 * n_rows))

cluster_dor_means = df_clustered.groupby('Cluster')['DoR'].mean()
cluster_labels = [f'Cluster {i}: avg DoR = {cluster_dor_means[i]:.2f}' for i in range(k)]

# Create density plots for each feature
for idx, feature in enumerate(features_for_clustering, 1):
    plt.subplot(n_rows, n_cols, idx)

    # Plot densities by k-means clusters
    for i in range(k):
        subset = df_clustered[df_clustered['Cluster'] == i][feature]
        sns.kdeplot(data=subset, label=cluster_labels[i], linestyle='-')

    # Plot densities by DoR groups
    for dor_group in ['Low', 'Medium', 'High']:
        subset = df_clustered[df_clustered['DoR_group'] == dor_group][feature]
        sns.kdeplot(data=subset, label=f'DoR {dor_group}', linestyle='--')

    plt.title(f'Distribution of {feature}')
    plt.xlabel(feature)
    plt.ylabel('Density')
    plt.legend()

    # Add legend for the first plot only to avoid clutter
    #if idx == 1:
     #   plt.legend(bbox_to_anchor=(1.05, 1), loc='upper left')

plt.tight_layout()
plt.show()

# Print summary statistics for each cluster
print("\nCluster Summary Statistics:")
for cluster in range(k):
    print(f"\nCluster {cluster} characteristics:")
    cluster_data = df_clustered[df_clustered['Cluster'] == cluster]
    print(f"Number of samples: {len(cluster_data)}")
    print(f"Average DoR: {cluster_data['DoR'].mean():.3f}")
    print("Feature means:")
    for feature in features_for_clustering:
        print(f"{feature}: {cluster_data[feature].mean():.3f}")

# Print correlations between features and DoR
print("\nCorrelations with DoR:")
correlations = df_clustered[features_for_clustering + ['DoR']].corr()['DoR'].sort_values(ascending=False)
print(correlations)


# Create DoR bins
bins = np.arange(0.3, 1, 0.1)  # Adjust range based on your DoR values
df_clustered['DoR_bin'] = pd.cut(df_clustered['DoR'], bins=bins)

# Count number of each cluster in each bin
cluster_counts = pd.crosstab(df_clustered['DoR_bin'], df_clustered['Cluster'])

# Calculate cluster means for labels
cluster_dor_means = df_clustered.groupby('Cluster')['DoR'].mean()
cluster_labels = [f'Cluster {i}: avg DoR = {cluster_dor_means[i]:.2f}' for i in range(k)]

# Create grouped bar plot
ax = cluster_counts.plot(kind='bar', figsize=(10, 6), width=0.8)
plt.title('Distribution of Clusters across DoR ranges')
plt.xlabel('DoR range')
plt.ylabel('Number of objects')
plt.legend(labels=cluster_labels)
plt.xticks(rotation=0)
plt.tight_layout()
plt.show()
